from __future__ import annotations

from pathlib import Path

import awkward as ak
import pytest
from lgdo import VectorOfVectors

from reboost.hpge import psd, utils

# fmt: off
# data from remage sim in simulation/ + some aggressive clustering
gamma_stp = ak.Array(
    {
        "edep": [
            [0.0571, 0.00863, 0.026, 0.072, 21.6, 1.09, 485],
            [0.0967, 0.00863, 0.026, 0.0175, 0.048, 0.0758, 0.0395, 23.8, 0.947, 505, 0.0148, 0.00863, 0.026, 284, 0.129, 7.25, 0.00863, 0.00863, 0.00926, 0.0506, 0.209, 5.84, 1.15, 8.38, 0.0171, 0.00926, 0.048, 1.09, 162],
            [0.117, 0.00863, 0.00863, 0.0486, 0.0478, 95.4, 0.00076, 0.0171, 0.00863, 0.00863, 0.0175, 0.0486, 0.0524, 0.04, 1.76, 0.961, 13.6, 0.00527, 0.0178, 0.0758, 0.0351, 438, 0.0377, 28.9, 0.0171, 0.0178, 0.625, 1.18, 6.5, 30.1, 0.0171, 0.026, 0.0175, 0.0524, 0.011, 8.29],
            [0.00353, 0.0169, 0.0178, 131],
            [0.073, 0.00863, 0.0171, 0.0805, 281],
            [0.0551, 0.00863, 0.026, 0.026, 0.048, 0.0734, 32, 1.02, 309],
            [0.0522, 0.0178, 0.026, 0.0758, 21.4, 1.09, 601, 0.143, 0.00863, 0.026, 188, 0.00863, 0.00926, 0.0524, 0.00863, 0.0351, 0.0179, 0.0523, 5.68, 0.987, 121, 0.0254, 0.0171, 0.0175, 0.0486, 0.113, 0.456, 0.946, 8.17, 0.184, 0.00863, 0.0171, 0.00926, 0.0175, 0.00863, 0.0486, 0.0254, 0.0517, 0.128, 0.974, 1.57, 1.06, 0.96, 7.61, 38],
            [0.123, 617, 0.116, 0.0171, 0.00863, 0.0171, 0.00926, 0.0486, 0.072, 0.0601, 0.0545, 0.374, 0.999, 24.4, 0.0591, 0.00863, 0.00863, 0.0175, 0.0178, 0.307, 0.0473, 0.0178, 0.0219, 3.2, 0.84, 46.8, 0.00863, 0.00863, 0.0486, 0.0909, 51.4, 0.0171, 0.00863, 0.00863, 0.0428, 0.916, 0.141, 1.1, 8.61],
            [0.232, 0.0256, 0.0171, 0.0486, 0.00926, 0.0395, 11.5, 1.18, 350, 0.00726, 0.00863, 0.0169, 366, 0.0118, 0.00863, 0.0169, 0.0486, 0.048, 134, 0.129, 0.00863, 0.0178, 34.5, 0.00863, 0.00926, 0.00926, 0.048, 0.00863, 0.207, 17, 0.141, 0.852, 83.6],
            [0.137, 0.0169, 0.00926, 730, 0.0171, 0.026, 0.0171, 0.00863, 0.048, 0.0486, 0.0717, 0.12, 8.87, 0.901, 0.0171, 0.00863, 0.00926, 0.0486, 0.00863, 0.0154, 0.382, 0.665, 0.803, 1.26, 0.12, 29, 0.00863, 0.00926, 0.00863, 0.048, 0.0171, 0.022, 0.324, 0.141, 1.04, 4.77, 221]
        ],
        "xloc": [
            [0.00187, 0.00223, 0.00223, 0.00223, 0.00223, 0.00223, 0.000217],
            [0.000439, 0.00247, 0.00247, 0.00247, 0.00247, 0.00247, 0.00247, 0.00247, 0.00247, 0.000298, 0.00952, 0.00952, 0.00952, 0.00137, 0.00781, 0.0039, 0.00693, 0.00693, 0.00693, 0.00693, 0.00693, 0.00693, 0.00693, 0.00693, 0.00693, 0.00693, 0.00693, 0.00693, 0.00139],
            [-0.00767, -0.0165, -0.0165, -0.0165, -0.0165, -0.00551, -0.0238, -0.0238, -0.0238, -0.0238, -0.0238, -0.0238, -0.0238, -0.0238, -0.0238, -0.0238, -0.0238, -0.0268, -0.0268, -0.0268, -0.0268, -0.00335, -0.0269, -0.0269, -0.0269, -0.0269, -0.0269, -0.0269, -0.0269, -0.0269, -0.0253, -0.0253, -0.0253, -0.0253, -0.0253, -0.0126],
            [-0.00844, -0.0101, -0.0101, -0.00203],
            [0.00638, 0.0395, 0.0395, 0.0395, 0.00494],
            [-0.0238, -0.0288, -0.0288, -0.0288, -0.0288, -0.0288, -0.0288, -0.0288, -0.0032],
            [0.00254, 0.00721, 0.00721, 0.00721, 0.00721, 0.00721, 0.000715, 0.0108, 0.0108, 0.0108, 0.00181, 0.0108, 0.0108, 0.0108, 0.0108, 0.0108, 0.0108, 0.0108, 0.0108, 0.0108, 0.00216, 0.0108, 0.0108, 0.0108, 0.0108, 0.0108, 0.0108, 0.0108, 0.0108, 0.0109, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116, 0.0116],
            [0.00286, 0.000745, 0.011, 0.011, 0.011, 0.011, 0.011, 0.011, 0.011, 0.011, 0.011, 0.011, 0.011, 0.011, 0.0135, 0.0135, 0.0135, 0.0135, 0.0135, 0.0135, 0.0135, 0.0135, 0.0135, 0.0135, 0.0135, 0.00674, 0.0337, 0.0337, 0.0337, 0.0337, 0.0112, 0.0336, 0.0336, 0.0336, 0.0336, 0.0336, 0.0336, 0.0336, 0.0336],
            [-0.00367, -0.00964, -0.00964, -0.00964, -0.00964, -0.00964, -0.00964, -0.00964, -0.00107, -0.0165, -0.0165, -0.0165, -0.00166, -0.0229, -0.0229, -0.0229, -0.0229, -0.0229, -0.00573, -0.0218, -0.0218, -0.0218, -0.0109, -0.0131, -0.0131, -0.0131, -0.0131, -0.0131, -0.0131, -0.0131, -0.0131, -0.0131, -0.00437],
            [0.0189, 0.04, 0.04, 0.00365, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0202, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.0404, 0.00577]
        ],
        "yloc": [
            [0.00624, 0.00731, 0.00731, 0.00731, 0.00731, 0.00731, 0.00073],
            [-0.00281, -0.0143, -0.0143, -0.0143, -0.0143, -0.0143, -0.0143, -0.0143, -0.0143, -0.0018, -0.012, -0.012, -0.012, -0.00172, -0.00901, -0.0045, -0.00413, -0.00413, -0.00413, -0.00413, -0.00413, -0.00413, -0.00413, -0.00413, -0.00413, -0.00413, -0.00413, -0.00413, -0.000822],
            [-0.00483, -0.0104, -0.0104, -0.0104, -0.0104, -0.00347, -0.0117, -0.0117, -0.0117, -0.0117, -0.0117, -0.0117, -0.0117, -0.0117, -0.0117, -0.0117, -0.0117, -0.012, -0.012, -0.012, -0.012, -0.0015, -0.012, -0.012, -0.012, -0.012, -0.012, -0.012, -0.012, -0.012, -0.0167, -0.0167, -0.0167, -0.0167, -0.0167, -0.00837],
            [-0.027, -0.0325, -0.0325, -0.00651],
            [-0.00396, -0.0233, -0.0233, -0.0233, -0.00291],
            [-0.0267, -0.0322, -0.0322, -0.0322, -0.0322, -0.0322, -0.0322, -0.0322, -0.00359],
            [-0.00676, -0.0192, -0.0192, -0.0192, -0.0192, -0.0192, -0.00193, -0.0201, -0.0201, -0.0201, -0.00335, -0.0198, -0.0198, -0.0198, -0.0198, -0.0198, -0.0198, -0.0198, -0.0198, -0.0198, -0.00397, -0.0198, -0.0198, -0.0198, -0.0198, -0.0198, -0.0198, -0.0198, -0.0198, -0.0198, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211, -0.0211],
            [-0.0135, -0.0035, 0.00945, 0.00945, 0.00945, 0.00945, 0.00945, 0.00945, 0.00945, 0.00945, 0.00945, 0.00945, 0.00945, 0.00945, 0.0107, 0.0107, 0.0107, 0.0107, 0.0107, 0.0107, 0.0107, 0.0107, 0.0107, 0.0107, 0.0107, 0.00537, 0.00728, 0.00728, 0.00728, 0.00728, 0.00243, 0.0073, 0.0073, 0.0073, 0.0073, 0.0073, 0.0073, 0.0073, 0.0073],
            [-0.00739, -0.02, -0.02, -0.02, -0.02, -0.02, -0.02, -0.02, -0.00223, -0.0216, -0.0216, -0.0216, -0.00216, -0.0139, -0.0139, -0.0139, -0.0139, -0.0139, -0.00347, -0.0181, -0.0181, -0.0181, -0.00905, -0.0148, -0.0148, -0.0148, -0.0148, -0.0148, -0.0148, -0.0148, -0.0148, -0.0148, -0.00492],
            [0.00418, 0.00888, 0.00888, 0.00081, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00485, 0.00242, 0.00485, 0.00483, 0.00486, 0.00486, 0.00486, 0.00486, 0.00486, 0.00486, 0.00486, 0.00486, 0.00486, 0.00486, 0.000686]
        ],
        "zloc": [
            [0, 0.00183, 0.00183, 0.00183, 0.00183, 0.00183, 0.000188],
            [0.00028, 0.0153, 0.0153, 0.0153, 0.0153, 0.0153, 0.0153, 0.0153, 0.0153, 0.00192, 0.0205, 0.0205, 0.0205, 0.00294, 0.014, 0.00701, 0.0102, 0.0102, 0.0102, 0.0102, 0.0102, 0.0102, 0.0102, 0.0102, 0.0102, 0.0102, 0.0102, 0.0102, 0.00205],
            [0.00559, 0.0129, 0.0129, 0.0129, 0.0129, 0.00431, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.0352, 0.0352, 0.0352, 0.0352, 0.00441, 0.0353, 0.0353, 0.0353, 0.0353, 0.0353, 0.0353, 0.0353, 0.0353, 0.0374, 0.0374, 0.0374, 0.0374, 0.0374, 0.0187],
            [0, 0.00202, 0.00202, 0.000402],
            [0, 0.0528, 0.0528, 0.0528, 0.0066],
            [0, 0.00206, 0.00206, 0.00206, 0.00206, 0.00206, 0.00206, 0.00206, 0.000228],
            [0.000411, 0.00514, 0.00514, 0.00514, 0.00514, 0.00514, 0.00052, 0.00349, 0.00349, 0.00349, 0.000578, 0.00343, 0.00343, 0.00343, 0.00343, 0.00343, 0.00343, 0.00343, 0.00343, 0.00343, 0.000685, 0.00336, 0.00336, 0.00336, 0.00336, 0.00336, 0.00336, 0.00336, 0.00336, 0.00338, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245, 0.00245],
            [0.00784, 0.00205, 0.0718, 0.0718, 0.0718, 0.0718, 0.0718, 0.0718, 0.0718, 0.0718, 0.0718, 0.0718, 0.0718, 0.0718, 0.0809, 0.0809, 0.0809, 0.0809, 0.0809, 0.0809, 0.0809, 0.0809, 0.0809, 0.0809, 0.0809, 0.0405, 0.0968, 0.0968, 0.0968, 0.0968, 0.0323, 0.0969, 0.0969, 0.0969, 0.0969, 0.0969, 0.0969, 0.0969, 0.0969],
            [0.0099, 0.0299, 0.0299, 0.0299, 0.0299, 0.0299, 0.0299, 0.0299, 0.00332, 0.0342, 0.0342, 0.0342, 0.00343, 0.0249, 0.0249, 0.0249, 0.0249, 0.0249, 0.00623, 0.0271, 0.0271, 0.0271, 0.0136, 0.0155, 0.0155, 0.0155, 0.0155, 0.0155, 0.0155, 0.0155, 0.0155, 0.0155, 0.00516],
            [0.0109, 0.0237, 0.0237, 0.00216, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0104, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.0208, 0.00298]
        ],
    }
)
# fmt: on


@pytest.fixture(scope="module")
def dt_map():
    return utils.get_hpge_scalar_rz_field(
        f"{Path(__file__).parent}/simulation/drift-time-maps.lh5",
        "V99999A",
        "drift_time",
        out_of_bounds_val=0,
        bounds_error=False,
        fill_value=0,
    )


def test_drift_time(dt_map):
    dt_values = psd.drift_time(
        gamma_stp.xloc,
        gamma_stp.xloc,
        gamma_stp.xloc,
        dt_map,
    )
    assert isinstance(dt_values, VectorOfVectors)
    assert dt_values.ndim == 2
    assert dt_values.attrs["units"] == "ns"
